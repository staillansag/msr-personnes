apiVersion: template.openshift.io/v1
kind: Template
labels:
message: "Deployment template for msr"
metadata:
  annotations:
    description: "Deployment template for msr"
  name: msr-deployment-template
  namespace: ${DEPLOY_NAMESPACE}  
objects:

  - apiVersion: apps/v1
    kind: Deployment
    metadata:
      labels:
        app: ${IMAGE_NAME}
      name: ${IMAGE_NAME}
      namespace: ${DEPLOY_NAMESPACE}    
    spec:
      replicas: 1
      strategy:
        type: RollingUpdate
        rollingUpdate:
          maxSurge: 1
          maxUnavailable: 0
      minReadySeconds: 0
      selector:
        matchLabels:
          app: ${IMAGE_NAME}
      template:
        metadata:
          annotations:
            prometheus.io/scrape: "true"
          labels:
            app: ${IMAGE_NAME}
        spec:
          containers:
            - image: image-registry.openshift-image-registry.svc:5000/${DEPLOY_NAMESPACE}/${IMAGE_NAME}:${IMAGE_RELEASE_NUMBER}
              imagePullPolicy: Always
              name: msr
              ports:
                - containerPort: 5543
                  name: https
                  protocol: TCP
                - containerPort: 9999
                  name: diag
                  protocol: TCP
                - containerPort: 5555
                  name: http
                  protocol: TCP
              env:
                - name: SERVER
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.name
              volumeMounts:
                - name: microservicesruntime-license
                  mountPath: /opt/softwareag/IntegrationServer/config/licenseKey.xml
                  subPath:   licenseKey.xml
                  readOnly:  true
                - name: application-properties
                  mountPath: /opt/softwareag/IntegrationServer/application.properties
                  subPath:   application.properties
                  readOnly:  true
                - name: secrets
                  mountPath: /etc/secrets
              resources:
                requests:
                  cpu: 500m
                  memory: 100Mi
                limits:
                  cpu: 1000m
                  memory: 2000Mi
              livenessProbe:
                tcpSocket:
                  port: 5555
                failureThreshold: 3
                initialDelaySeconds: 180
                periodSeconds: 30
                successThreshold: 1
                timeoutSeconds: 1
              readinessProbe:
                tcpSocket:
                  port: 5555
                initialDelaySeconds: 5
                periodSeconds: 5
                failureThreshold: 24
          volumes:
            - name: secrets
              secret:
                secretName: environment-secret
            - name: microservicesruntime-license
              secret:
                secretName: licenses
                defaultMode: 0666
                items:
                - key:  msr-license
                  path: licenseKey.xml
            - name: application-properties
              configMap:
                name: ${IMAGE_NAME}
                items:
                - key:  application.properties
                  path: application.properties

parameters:
  - name: DEPLOY_NAMESPACE
    required: true
  - name: IMAGE_NAME
    required: true
  - name: IMAGE_RELEASE_NUMBER
    required: true